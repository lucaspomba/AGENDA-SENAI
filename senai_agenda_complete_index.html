<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Senai - Agenda de Aulas</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

  <!-- Toastify for notifications -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <style>
    /* =========================
       Basic layout + variables
       ========================= */
    :root{
      --bg: #f3f4f6; --panel: #ffffff; --text: #111827; --muted:#6b7280;
      --accent: #6366f1; --accent-2: #0ea5e9;
      --success: #059669; --warn:#d97706; --danger:#ef4444;
      --glass: rgba(255,255,255,0.6);
      --transition: 180ms cubic-bezier(.2,.9,.3,1);
    }
    .dark{
      --bg: #071230; --panel: #071028; --text: #e6eef8; --muted:#9aa9bf;
      --accent: #7dd3fc; --accent-2: #38bdf8;
      --glass: rgba(8,12,20,0.6);
    }

    html,body,#calendar { height: 100%; }
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      transition: background var(--transition), color var(--transition);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    /* When dark mode toggle, change font to monospace for readability per your request */
    .dark { font-family: "Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace; }

    /* container & panels */
    .panel { background:var(--panel); color:var(--text); transition: background var(--transition), color var(--transition); }
    .btn { transition: transform .12s ease, box-shadow .12s ease; }
    .btn:active{ transform: translateY(1px) scale(.998); }
    .btn:hover{ box-shadow: 0 6px 18px rgba(2,6,23,0.08); }

    .small-muted { color:var(--muted); font-size:13px; }

    /* FullCalendar adjustments */
    .fc .fc-event { cursor: pointer; border-radius:6px; }
    .fc .fc-timegrid-slot-label { color:var(--muted); }

    /* Modal */
    #event-modal {
      position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
      background: rgba(2,6,23,0.45); z-index:12000;
      opacity:0; transition: opacity 160ms ease;
    }
    #event-modal.active { display:flex; opacity:1; }
    .modal-card {
      width:720px; max-width:96%; border-radius:12px; padding:18px; box-shadow:0 14px 40px rgba(2,6,23,0.3);
      background:var(--panel); color:var(--text); transform: translateY(8px) scale(.995); transition: transform 160ms ease, opacity 160ms;
      opacity:0;
    }
    #event-modal.active .modal-card{ transform: translateY(0) scale(1); opacity:1; }

    /* auth screen */
    .auth-screen {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:13000;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(245,247,250,0.85));
    }
    .auth-card{ width:100%; max-width:420px; border-radius:12px; padding:22px; box-shadow:0 18px 60px rgba(2,6,23,0.12); background:var(--panel); }

    /* toast container (we'll also use Toastify for nicer UI) */
    #toast-container { position:fixed; right:18px; bottom:18px; z-index:14000; display:flex; flex-direction:column; gap:8px; }

    /* small responsive */
    @media (max-width:900px){
      aside{ width:100% !important; position:relative; }
      .h-full.flex{ flex-direction:column; height:100vh; }
      main{ padding:12px; }
      .modal-card{ width:calc(100% - 28px); }
    }

    /* subtle animations for inputs/buttons */
    input, select, textarea, button { transition: box-shadow .12s ease, transform .08s ease; }
    input:focus, select:focus, textarea:focus { box-shadow:0 8px 20px rgba(2,6,23,0.06); outline:none; border-color:var(--accent-2); }

    /* Add visually-clear disabled look */
    button[disabled] { opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }

    /* small helper for hidden elements */
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <!-- TOAST CONTAINER (backup) -->
  <div id="toast-container"></div>

  <!-- ===== AUTH (LOGIN / REGISTER) ===== -->
  <div id="login-screen" class="auth-screen">
    <div class="auth-card">
      <div class="flex justify-center mb-4">
        <!-- Coloque sua logo em img/logo-senai.png -->
        <img id="login-logo" src="img/R.png" alt="Logo SENAI" class="h-20 w-auto">
      </div>
      <h1 class="text-2xl font-bold text-center mb-4">Entrar</h1>
      <input id="login-email" type="email" placeholder="E-mail" class="p-2 border rounded w-full mb-3" />
      <input id="login-password" type="password" placeholder="Senha" class="p-2 border rounded w-full mb-3" />
      <button id="login-btn" class="w-full btn btn-accent p-2 rounded mb-3" style="background:var(--accent);color:white;">Entrar</button>
      <p class="text-sm text-center small-muted">Não tem conta? <a href="#" id="go-register" class="underline">Cadastre-se</a></p>
    </div>
  </div>

  <div id="register-screen" class="auth-screen hidden">
    <div class="auth-card">
      <div class="flex justify-center mb-4">
        <img id="register-logo" src="img/R.png" alt="Logo SENAI" class="h-20 w-auto">
      </div>
      <h1 class="text-2xl font-bold text-center mb-4">Cadastro</h1>
      <input id="register-name" type="text" placeholder="Nome completo" class="p-2 border rounded w-full mb-3" />
      <input id="register-email" type="email" placeholder="E-mail" class="p-2 border rounded w-full mb-3" />
      <input id="register-password" type="password" placeholder="Senha" class="p-2 border rounded w-full mb-3" />
      <button id="register-btn" class="w-full btn btn-accent p-2 rounded mb-3" style="background:#10b981;color:white;">Cadastrar</button>
      <p class="text-sm text-center small-muted">Já tem conta? <a href="#" id="go-login" class="underline">Faça login</a></p>
    </div>
  </div>

  <!-- ===== APP (escondido até login) ===== -->
  <div id="app-screen" class="h-full flex hidden" style="height:100vh;">
    <!-- Lateral: Cadastros / controles -->
    <aside class="w-96 p-4 panel border-r overflow-auto" style="min-width:280px;">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Painel Senai — Agenda</h1>
        <div class="flex gap-2 items-center">
          <button id="theme-toggle" title="Alternar tema" class="px-2 py-1 border rounded btn">Tema</button>
          <button id="logout-btn" class="text-sm text-red-600 border px-2 py-1 rounded btn">Sair</button>
        </div>
      </div>

      <section class="mb-6">
        <h2 class="font-semibold">Professores</h2>
        <div id="teachers-list" class="mt-2 space-y-2"></div>
        <div class="mt-3">
          <input id="teacher-name" placeholder="Nome do professor" class="p-2 border rounded w-full" />
          <input id="teacher-area" placeholder="Área / disciplina" class="p-2 border rounded w-full mt-2" />
          <button id="add-teacher" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded btn">Adicionar Professor</button>
        </div>
      </section>

      <section class="mb-6">
        <h2 class="font-semibold">Cursos</h2>
        <div id="courses-list" class="mt-2 space-y-2"></div>
        <div class="mt-3">
          <input id="course-name" placeholder="Nome do curso" class="p-2 border rounded w-full" />
          <input id="course-hours" placeholder="Carga horária (opcional)" class="p-2 border rounded w-full mt-2" />
          <button id="add-course" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded btn">Adicionar Curso</button>
        </div>
      </section>

      <section class="mb-6">
        <h2 class="font-semibold">Filtros</h2>
        <select id="filter-professor" class="w-full p-2 border rounded mt-2">
          <option value="">Todos os professores</option>
        </select>
        <select id="filter-course" class="w-full p-2 border rounded mt-2">
          <option value="">Todos os cursos</option>
        </select>
        <div class="flex gap-2 mt-2">
          <button id="clear-filters" class="flex-1 p-2 bg-gray-300 rounded btn">Limpar</button>
          <button id="today-btn" class="flex-1 p-2 btn-accent rounded" style="background:var(--accent);color:white;">Aplicar</button>
        </div>
      </section>

      <section>
        <h2 class="font-semibold">Atalhos</h2>
        <div class="mt-2 space-y-2">
          <div class="small-muted">Pressione <kbd style="background:#111827;color:white;padding:2px 6px;border-radius:6px">F11</kbd> para novo agendamento</div>
          <button id="open-event-modal" class="w-full p-2 bg-indigo-500 text-white rounded btn mt-2">Agendar Aula</button>
          <button id="export-data" class="w-full p-2 bg-gray-800 text-white rounded btn">Exportar JSON</button>
          <button id="import-data" class="w-full p-2 bg-yellow-500 text-black rounded btn">Importar JSON</button>
          <input id="import-file" type="file" accept="application/json" class="hidden" />
        </div>
      </section>

      <footer class="mt-6 text-xs text-gray-500 small-muted">Dados salvos localmente no navegador (localStorage). Use exportar/importar para backup.</footer>
    </aside>

    <!-- Conteúdo principal: calendário -->
    <main class="flex-1 p-4">
      <div class="panel p-4 rounded shadow h-full flex flex-col" style="height:calc(100vh - 32px);">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-xl font-semibold">Calendário Semanal</h2>
            <p class="text-sm text-gray-500 small-muted">Visualize e organize as aulas dos professores</p>
          </div>
          <div class="space-x-2">
            <button id="week-view" class="px-3 py-1 border rounded btn">Semana</button>
            <button id="month-view" class="px-3 py-1 border rounded btn">Mês</button>
            <button id="list-view" class="px-3 py-1 border rounded btn">Lista</button>
          </div>
        </div>

        <div id="calendar" class="flex-1"></div>
      </div>
    </main>
  </div>

  <!-- Modal de evento -->
  <div id="event-modal" aria-hidden="true">
    <div class="modal-card">
      <h3 class="text-lg font-bold mb-3">Agendar / Editar Aula</h3>
      <form id="event-form" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Turma (nome)</label>
            <input id="ev-title" class="w-full p-2 border rounded" placeholder="Ex: Turma A - 2º período" required />
          </div>
          <div>
            <label class="block text-sm">Curso</label>
            <select id="ev-course" class="w-full p-2 border rounded"></select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Professor</label>
            <select id="ev-teacher" class="w-full p-2 border rounded" required></select>
          </div>
          <div>
            <label class="block text-sm">Sala / Observação</label>
            <input id="ev-location" class="w-full p-2 border rounded" placeholder="Sala 101, Observação..." />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Data de Início</label>
            <input id="ev-start-date" type="date" class="w-full p-2 border rounded" required />
          </div>
          <div>
            <label class="block text-sm">Hora de Início</label>
            <input id="ev-start-time" type="time" class="w-full p-2 border rounded" required />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Data Final (mesmo dia se não recorrente)</label>
            <input id="ev-end-date" type="date" class="w-full p-2 border rounded" required />
          </div>
          <div>
            <label class="block text-sm">Hora de Término</label>
            <input id="ev-end-time" type="time" class="w-full p-2 border rounded" required />
          </div>
        </div>

        <div class="flex items-center gap-3">
          <input id="ev-recurring" type="checkbox" />
          <label class="text-sm">Repetir semanalmente até data final</label>
        </div>

        <input type="hidden" id="ev-id">

        <div class="flex justify-end gap-2">
          <button type="button" id="delete-event" class="bg-red-500 text-white px-3 py-2 rounded hidden">Excluir</button>
          <button type="button" id="cancel-event" class="px-3 py-2 border rounded">Cancelar</button>
          <button type="submit" class="px-3 py-2 bg-indigo-600 text-white rounded">Salvar</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* =========================
   Storage / helpers
   ========================= */
const STORAGE_KEYS = {
  theme: 'senai_theme',
  users: 'senai_users',
  teachers: 'senai_teachers',
  courses: 'senai_courses',
  events: 'senai_events'
};
function load(key, fallback=[]){ try{ return JSON.parse(localStorage.getItem(key)) || fallback }catch(e){ return fallback } }
function save(key,data){ localStorage.setItem(key, JSON.stringify(data)); }
function uid(){ return 'id-'+Math.random().toString(36).slice(2,9); }

/* Toast helper using Toastify + fallback to simple DOM */
function showToast(msg, opts={}){
  const bg = opts.bg || '#4ade80';
  if(window.Toastify){
    Toastify({ text: msg, duration: opts.duration || 2500, gravity:"top", position:"right",
      style:{ background: bg, color:'#0b1220' }
    }).showToast();
    return;
  }
  // fallback
  const c = document.getElementById('toast-container');
  const el = document.createElement('div'); el.textContent=msg;
  el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.background=bg; el.style.color='white';
  el.style.boxShadow='0 8px 30px rgba(2,6,23,0.12)'; c.appendChild(el);
  setTimeout(()=> el.remove(), 3000);
}

/* ======================
   Initial data
   ====================== */
let users = load(STORAGE_KEYS.users);
let teachers = load(STORAGE_KEYS.teachers);
let courses = load(STORAGE_KEYS.courses);
let storedEvents = load(STORAGE_KEYS.events);

/* DOM refs */
const loginScreen = document.getElementById('login-screen');
const registerScreen = document.getElementById('register-screen');
const appScreen = document.getElementById('app-screen');

const loginEmail = document.getElementById('login-email');
const loginPass = document.getElementById('login-password');
const loginBtn = document.getElementById('login-btn');

const regName = document.getElementById('register-name');
const regEmail = document.getElementById('register-email');
const regPass = document.getElementById('register-password');
const regBtn = document.getElementById('register-btn');

const teachersList = document.getElementById('teachers-list');
const coursesList = document.getElementById('courses-list');
const filterProfessor = document.getElementById('filter-professor');
const filterCourse = document.getElementById('filter-course');

const calendarEl = document.getElementById('calendar');
const eventModal = document.getElementById('event-modal');
const eventForm = document.getElementById('event-form');

/* Auth navigation */
document.getElementById('go-register').addEventListener('click', e=>{ e.preventDefault(); loginScreen.classList.add('hidden'); registerScreen.classList.remove('hidden'); });
document.getElementById('go-login').addEventListener('click', e=>{ e.preventDefault(); registerScreen.classList.add('hidden'); loginScreen.classList.remove('hidden'); });

/* Register (local demo only) */
regBtn.addEventListener('click', ()=>{
  const name = regName.value.trim(), email = regEmail.value.trim(), pass = regPass.value.trim();
  if(!name||!email||!pass){ showToast('Preencha todos os campos', {bg:'#f59e0b'}); return; }
  if(users.some(u=>u.email===email)){ showToast('E-mail já cadastrado', {bg:'#f97316'}); return; }
  users.push({ id: uid(), name, email, pass });
  save(STORAGE_KEYS.users, users);
  showToast('Cadastro realizado! Faça login.', {bg:'#10b981'});
  regName.value=''; regEmail.value=''; regPass.value='';
  registerScreen.classList.add('hidden'); loginScreen.classList.remove('hidden');
});

/* Login (local demo only) */
loginBtn.addEventListener('click', ()=>{
  const email = loginEmail.value.trim(), pass = loginPass.value.trim();
  if(!email||!pass){ showToast('Preencha e-mail e senha', {bg:'#f59e0b'}); return; }
  const user = users.find(u=>u.email===email && u.pass===pass);
  if(!user){ showToast('Credenciais inválidas', {bg:'#ef4444'}); return; }
  loginEmail.value=''; loginPass.value='';
  loginScreen.classList.add('hidden'); registerScreen.classList.add('hidden'); appScreen.classList.remove('hidden');
  showToast('Bem-vindo, '+(user.name||'Usuário'), {bg:'#60a5fa'});
  startApp();
});

/* Logout */
document.getElementById('logout-btn').addEventListener('click', ()=>{
  if(!confirm('Deseja realmente sair?')) return;
  appScreen.classList.add('hidden'); loginScreen.classList.remove('hidden');
  location.reload();
});

/* Teachers / courses management */
document.getElementById('add-teacher').addEventListener('click', ()=>{
  const name = document.getElementById('teacher-name').value.trim();
  const area = document.getElementById('teacher-area').value.trim();
  if(!name){ showToast('Nome do professor é obrigatório',{bg:'#f97316'}); return; }
  teachers.push({ id: uid(), name, area });
  save(STORAGE_KEYS.teachers, teachers);
  document.getElementById('teacher-name').value=''; document.getElementById('teacher-area').value='';
  renderTeachers(); populateFilters(); populateFormSelects();
  showToast('Professor adicionado',{bg:'#10b981'});
});

document.getElementById('add-course').addEventListener('click', ()=>{
  const name = document.getElementById('course-name').value.trim();
  const hours = document.getElementById('course-hours').value.trim();
  if(!name){ showToast('Nome do curso é obrigatório',{bg:'#f97316'}); return; }
  courses.push({ id: uid(), name, hours });
  save(STORAGE_KEYS.courses, courses);
  document.getElementById('course-name').value=''; document.getElementById('course-hours').value='';
  renderCourses(); populateFilters(); populateFormSelects();
  showToast('Curso adicionado',{bg:'#10b981'});
});

function renderTeachers(){
  teachersList.innerHTML=''; if(!teachers.length){ teachersList.innerHTML='<div class="small-muted">Nenhum professor cadastrado</div>'; return; }
  teachers.forEach(t=>{
    const div = document.createElement('div');
    div.className='p-2 border rounded flex justify-between items-center';
    div.innerHTML = `<div><div class="font-semibold">${t.name}</div><div class="text-xs small-muted">${t.area||''}</div></div><div><button class="text-red-500 btn" data-id="${t.id}">Remover</button></div>`;
    teachersList.appendChild(div);
    div.querySelector('button').addEventListener('click', ()=>{
      if(!confirm('Remover professor?')) return;
      teachers = teachers.filter(x=>x.id!==t.id); save(STORAGE_KEYS.teachers, teachers);
      renderTeachers(); populateFilters(); populateFormSelects();
      showToast('Professor removido',{bg:'#60a5fa'});
    });
  });
}
function renderCourses(){
  coursesList.innerHTML=''; if(!courses.length){ coursesList.innerHTML='<div class="small-muted">Nenhum curso cadastrado</div>'; return; }
  courses.forEach(c=>{
    const div = document.createElement('div');
    div.className='p-2 border rounded flex justify-between items-center';
    div.innerHTML = `<div><div class="font-semibold">${c.name}</div><div class="text-xs small-muted">${c.hours||''}</div></div><div><button class="text-red-500 btn" data-id="${c.id}">Remover</button></div>`;
    coursesList.appendChild(div);
    div.querySelector('button').addEventListener('click', ()=>{
      if(!confirm('Remover curso?')) return;
      courses = courses.filter(x=>x.id!==c.id); save(STORAGE_KEYS.courses, courses);
      renderCourses(); populateFilters(); populateFormSelects();
      showToast('Curso removido',{bg:'#60a5fa'});
    });
  });
}

function populateFilters(){
  filterProfessor.innerHTML = `<option value="">Todos os professores</option>` + teachers.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  filterCourse.innerHTML = `<option value="">Todos os cursos</option>` + courses.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}
function populateFormSelects(){
  const evTeacher = document.getElementById('ev-teacher');
  const evCourse = document.getElementById('ev-course');
  evTeacher.innerHTML = '<option value="">Selecione professor</option>' + teachers.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  evCourse.innerHTML = '<option value="">Selecione curso</option>' + courses.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

/* FullCalendar wiring */
let calendar = null;
function mapStoredEventsToCalendar(sts){
  return sts.map(ev=>({
    id: ev.id,
    title: formatEventTitle(ev),
    start: ev.start,
    end: ev.end,
    extendedProps: { ...ev, _customId: ev.id }
  }));
}
function formatEventTitle(ev){ return `[${ev.courseName||''}] ${ev.title} — ${ev.teacherName||''}`.replace(/\[\s*\]/,''); }

function initCalendar(){
  calendar = new FullCalendar.Calendar(calendarEl, {
    locale: 'pt-br',
    initialView: 'timeGridWeek',
    height: '100%',
    nowIndicator: true,
    slotMinTime: '06:00:00',
    slotMaxTime: '22:00:00',
    selectable: true,
    editable: true,
    navLinks: true,
    headerToolbar: false,
    events: mapStoredEventsToCalendar(storedEvents),
    select: info => openEventModal(null, info.start, info.end),
    eventClick: info => openEventModal(info.event.extendedProps._customId || info.event.id),
    eventDrop: handleEventDrop,
    eventResize: handleEventResize
  });
  calendar.render();
}

/* refresh */
function refreshCalendar(){
  storedEvents = load(STORAGE_KEYS.events);
  if(!calendar) return;
  calendar.removeAllEvents();
  calendar.addEventSource(mapStoredEventsToCalendar(storedEvents));
}

/* conflict check */
function hasConflict(newStart,newEnd,teacherId,ignoreEventId=null){
  const ns = new Date(newStart).getTime();
  const ne = new Date(newEnd).getTime();
  return storedEvents.some(ev=>{
    if(ignoreEventId && ev.id === ignoreEventId) return false;
    if(ev.teacherId !== teacherId) return false;
    const s = new Date(ev.start).getTime(), e = new Date(ev.end).getTime();
    return (ns < e) && (ne > s);
  });
}

function handleEventDrop(info){
  const ev = storedEvents.find(e=>e.id===info.event.id);
  const newStart = info.event.start, newEnd = info.event.end;
  if(hasConflict(newStart,newEnd,ev.teacherId,ev.id)){
    showToast('Conflito: professor já tem aula nesse horário. Movimento cancelado',{bg:'#f97316'});
    info.revert(); return;
  }
  ev.start = newStart.toISOString(); ev.end = newEnd.toISOString();
  save(STORAGE_KEYS.events, storedEvents);
  showToast('Evento movido',{bg:'#34d399'});
}
function handleEventResize(info){
  const ev = storedEvents.find(e=>e.id===info.event.id);
  const newStart = info.event.start, newEnd = info.event.end;
  if(hasConflict(newStart,newEnd,ev.teacherId,ev.id)){
    showToast('Conflito ao redimensionar: ação cancelada',{bg:'#f97316'});
    info.revert(); return;
  }
  ev.start = newStart.toISOString(); ev.end = newEnd.toISOString();
  save(STORAGE_KEYS.events, storedEvents);
  showToast('Duração atualizada',{bg:'#34d399'});
}

/* Modal controls */
document.getElementById('open-event-modal').addEventListener('click', ()=> openEventModal());
document.getElementById('cancel-event').addEventListener('click', closeEventModal);
document.getElementById('delete-event').addEventListener('click', deleteEventFromModal);

function openEventModal(eventId=null, start=null, end=null){
  document.getElementById('ev-id').value = eventId || '';
  document.getElementById('delete-event').classList.toggle('hidden', !eventId);
  populateFormSelects();

  if(eventId){
    const ev = storedEvents.find(e=>e.id===eventId);
    if(!ev){ showToast('Evento não encontrado',{bg:'#f97316'}); return; }
    document.getElementById('ev-title').value = ev.title;
    document.getElementById('ev-course').value = ev.courseId || '';
    document.getElementById('ev-teacher').value = ev.teacherId || '';
    document.getElementById('ev-location').value = ev.location || '';
    const s = new Date(ev.start), e = new Date(ev.end);
    document.getElementById('ev-start-date').value = s.toISOString().slice(0,10);
    document.getElementById('ev-start-time').value = s.toTimeString().slice(0,5);
    document.getElementById('ev-end-date').value = e.toISOString().slice(0,10);
    document.getElementById('ev-end-time').value = e.toTimeString().slice(0,5);
    document.getElementById('ev-recurring').checked = false;
  } else {
    document.getElementById('ev-title').value = '';
    document.getElementById('ev-course').value = '';
    document.getElementById('ev-teacher').value = '';
    document.getElementById('ev-location').value = '';
    if(start && end){
      const s = new Date(start), e = new Date(end);
      document.getElementById('ev-start-date').value = s.toISOString().slice(0,10);
      document.getElementById('ev-start-time').value = s.toTimeString().slice(0,5);
      document.getElementById('ev-end-date').value = e.toISOString().slice(0,10);
      document.getElementById('ev-end-time').value = e.toTimeString().slice(0,5);
    } else {
      const today = new Date();
      document.getElementById('ev-start-date').value = today.toISOString().slice(0,10);
      document.getElementById('ev-end-date').value = today.toISOString().slice(0,10);
      document.getElementById('ev-start-time').value = '13:00';
      document.getElementById('ev-end-time').value = '15:00';
    }
  }

  eventModal.classList.add('active'); eventModal.setAttribute('aria-hidden','false');
  setTimeout(()=> document.getElementById('ev-title').focus(), 160);
}
function closeEventModal(){ eventModal.classList.remove('active'); eventModal.setAttribute('aria-hidden','true'); }

function deleteEventFromModal(){
  const id = document.getElementById('ev-id').value;
  if(!id) return; if(!confirm('Excluir evento?')) return;
  storedEvents = storedEvents.filter(e=>e.id!==id);
  save(STORAGE_KEYS.events, storedEvents); refreshCalendar(); closeEventModal(); showToast('Evento excluído',{bg:'#f87171'});
}

eventForm.addEventListener('submit', e=>{
  e.preventDefault();
  const id = document.getElementById('ev-id').value || uid();
  const title = document.getElementById('ev-title').value.trim();
  const courseId = document.getElementById('ev-course').value;
  const courseName = (courses.find(c=>c.id===courseId) || {}).name || '';
  const teacherId = document.getElementById('ev-teacher').value;
  const teacherName = (teachers.find(t=>t.id===teacherId) || {}).name || '';
  const location = document.getElementById('ev-location').value.trim();
  const startDate = document.getElementById('ev-start-date').value;
  const startTime = document.getElementById('ev-start-time').value;
  const endDate = document.getElementById('ev-end-date').value;
  const endTime = document.getElementById('ev-end-time').value;
  const recurring = document.getElementById('ev-recurring').checked;

  const startISO = new Date(startDate+'T'+startTime+':00').toISOString();
  const endISO = new Date(endDate+'T'+endTime+':00').toISOString();
  if(new Date(startISO) >= new Date(endISO)){ showToast('Hora de término deve ser depois da hora de início.',{bg:'#f97316'}); return; }

  if(recurring){
    const baseStart = new Date(startDate+'T'+startTime+':00');
    const finalDate = new Date(endDate+'T23:59:59');
    let cursor = new Date(baseStart);
    const created = [];
    while(cursor <= finalDate){
      const s = new Date(cursor);
      const e = new Date(s.getTime() + (new Date(endISO)-new Date(startISO)));
      if(hasConflict(s,e,teacherId,null)){
        console.warn('Conflito detectado em '+s.toLocaleString());
        showToast('Conflito detectado em '+s.toLocaleDateString()+' — pulando',{bg:'#f97316'});
      } else {
        const evObj = { id: uid(), title, courseId, courseName, teacherId, teacherName, location, start: s.toISOString(), end: e.toISOString() };
        storedEvents.push(evObj); created.push(evObj);
      }
      cursor.setDate(cursor.getDate()+7);
    }
    save(STORAGE_KEYS.events, storedEvents); refreshCalendar(); closeEventModal();
    showToast(`${created.length} eventos criados (recorrência)`,{bg:'#34d399'}); return;
  }

  if(hasConflict(startISO,endISO,teacherId,id)){ showToast('Conflito: professor já tem aula nesse horário.',{bg:'#f97316'}); return; }
  const existsIndex = storedEvents.findIndex(x=>x.id===id);
  const evObj = { id, title, courseId, courseName, teacherId, teacherName, location, start: startISO, end: endISO };
  if(existsIndex>=0) storedEvents[existsIndex] = evObj; else storedEvents.push(evObj);
  save(STORAGE_KEYS.events, storedEvents); refreshCalendar(); closeEventModal();
  showToast(existsIndex>=0 ? 'Evento atualizado':'Evento criado',{bg:'#34d399'});
});

/* Filters / Views */
document.getElementById('filter-professor').addEventListener('change', applyFilters);
document.getElementById('filter-course').addEventListener('change', applyFilters);
document.getElementById('clear-filters').addEventListener('click', ()=>{ filterProfessor.value=''; filterCourse.value=''; applyFilters(); });
document.getElementById('today-btn').addEventListener('click', ()=> calendar && calendar.today());

function applyFilters(){
  const prof = filterProfessor.value, course = filterCourse.value;
  if(!calendar) return;
  calendar.removeAllEvents();
  let filtered = storedEvents.slice();
  if(prof) filtered = filtered.filter(e=>e.teacherId===prof);
  if(course) filtered = filtered.filter(e=>e.courseId===course);
  calendar.addEventSource(mapStoredEventsToCalendar(filtered));
}

/* Export / Import */
document.getElementById('export-data').addEventListener('click', ()=>{
  const dump = { teachers, courses, events: storedEvents };
  const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'senai_agenda_export.json'; a.click(); URL.revokeObjectURL(url);
  showToast('Exportado como JSON',{bg:'#60a5fa'});
});
document.getElementById('import-data').addEventListener('click', ()=> document.getElementById('import-file').click());
document.getElementById('import-file').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const parsed = JSON.parse(txt);
    teachers = parsed.teachers || teachers; courses = parsed.courses || courses; storedEvents = parsed.events || storedEvents;
    save(STORAGE_KEYS.teachers, teachers); save(STORAGE_KEYS.courses, courses); save(STORAGE_KEYS.events, storedEvents);
    renderTeachers(); renderCourses(); populateFilters(); populateFormSelects(); refreshCalendar();
    showToast('Importado com sucesso',{bg:'#34d399'});
  }catch(e){ showToast('Arquivo inválido',{bg:'#f97316'}); }
});

/* Theme toggle with persistence */
const themeToggle = document.getElementById('theme-toggle');
function applyTheme(t){
  if(t==='dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
  save(STORAGE_KEYS.theme, t);
}
(function initTheme(){
  const saved = localStorage.getItem(STORAGE_KEYS.theme) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  applyTheme(saved);
})();
themeToggle.addEventListener('click', ()=>{
  const cur = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
  applyTheme(cur==='dark' ? 'light' : 'dark');
  showToast('Tema alterado',{bg:'#60a5fa'});
});

/* Keyboard shortcuts:
   - F11 => open new event modal (you requested)
   - Ctrl/Cmd+N also supported
   - Esc closes modal
*/
document.addEventListener('keydown', (ev)=>{
  if(ev.key === 'F11'){ ev.preventDefault(); openEventModal(); }
  if((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 'n'){ ev.preventDefault(); openEventModal(); }
  if(ev.key === 'Escape'){ if(eventModal.classList.contains('active')) closeEventModal(); }
});

/* Views buttons */
document.getElementById('week-view').addEventListener('click', ()=> calendar && calendar.changeView('timeGridWeek'));
document.getElementById('month-view').addEventListener('click', ()=> calendar && calendar.changeView('dayGridMonth'));
document.getElementById('list-view').addEventListener('click', ()=> calendar && calendar.changeView('listWeek'));

/* Open modal button */
document.getElementById('open-event-modal').addEventListener('click', ()=> openEventModal());

/* Start app helper */
function startApp(){
  renderTeachers(); renderCourses(); populateFilters(); populateFormSelects();
  initCalendar();
  showToast('App iniciado — use F11 para novo agendamento',{bg:'#60a5fa', duration:5000});
}

/* If you'd like an auto-test user uncomment following lines (dev only):
if(!users.length){ users.push({id:uid(),name:'Admin',email:'admin@senai',pass:'1234'}); save(STORAGE_KEYS.users,users); }
*/

/* App does not auto-login by default. */
</script>
</body>
</html>
