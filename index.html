<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Senai - Agenda de Aulas</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

  <style>
    html,body,#calendar { height: 100%; }
    .fc .fc-event { cursor: pointer; }

    /* Modal centralizado com fundo opaco e alto z-index */
    #event-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #event-modal.active { display: flex; }
    /* Ajuste do inner modal para evitar clique por fora */
    #event-modal .modal-card { position: relative; z-index: 10000; }

    /* Tela de login / register full screen (acima do app) */
    .auth-screen { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: #f3f4f6; z-index:10010; }
    .auth-card { background:white; padding:24px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.12); width:100%; max-width:380px; }
  </style>
</head>
<body class="h-screen bg-gray-100 font-sans">
  <!-- ===== AUTH (LOGIN / REGISTER) ===== -->
  <div id="login-screen" class="auth-screen">
    <div class="auth-card">
      <div class="flex justify-center mb-4">
        <!-- Troque o src para sua logo (ex: logo-senai.png) -->
        <img id="login-logo" src="logo-senai.png" alt="Logo SENAI" class="h-20 w-auto">
      </div>
      <h1 class="text-2xl font-bold text-center mb-4">Entrar</h1>
      <input id="login-email" type="email" placeholder="E-mail" class="p-2 border rounded w-full mb-3" />
      <input id="login-password" type="password" placeholder="Senha" class="p-2 border rounded w-full mb-3" />
      <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded mb-3">Entrar</button>
      <p class="text-sm text-center">Não tem conta? <a href="#" id="go-register" class="text-blue-600">Cadastre-se</a></p>
    </div>
  </div>

  <div id="register-screen" class="auth-screen" style="display:none;">
    <div class="auth-card">
      <div class="flex justify-center mb-4">
        <img id="register-logo" src="logo-senai.png" alt="Logo SENAI" class="h-20 w-auto">
      </div>
      <h1 class="text-2xl font-bold text-center mb-4">Cadastro</h1>
      <input id="register-name" type="text" placeholder="Nome completo" class="p-2 border rounded w-full mb-3" />
      <input id="register-email" type="email" placeholder="E-mail" class="p-2 border rounded w-full mb-3" />
      <input id="register-password" type="password" placeholder="Senha" class="p-2 border rounded w-full mb-3" />
      <button id="register-btn" class="w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded mb-3">Cadastrar</button>
      <p class="text-sm text-center">Já tem conta? <a href="#" id="go-login" class="text-blue-600">Faça login</a></p>
    </div>
  </div>

  <!-- ===== APP (escondido até login) ===== -->
  <div id="app-screen" class="h-full flex" style="display:none;">
    <!-- Lateral: Cadastros / controles -->
    <aside class="w-96 p-4 bg-white border-r overflow-auto">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Painel Senai — Agenda</h1>
        <button id="logout-btn" class="text-sm text-red-600 border px-2 py-1 rounded">Sair</button>
      </div>

      <section class="mb-6">
        <h2 class="font-semibold">Professores</h2>
        <div id="teachers-list" class="mt-2 space-y-2"></div>
        <div class="mt-3">
          <input id="teacher-name" placeholder="Nome do professor" class="p-2 border rounded w-full" />
          <input id="teacher-area" placeholder="Área / disciplina" class="p-2 border rounded w-full mt-2" />
          <button id="add-teacher" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded">Adicionar Professor</button>
        </div>
      </section>

      <section class="mb-6">
        <h2 class="font-semibold">Cursos</h2>
        <div id="courses-list" class="mt-2 space-y-2"></div>
        <div class="mt-3">
          <input id="course-name" placeholder="Nome do curso" class="p-2 border rounded w-full" />
          <input id="course-hours" placeholder="Carga horária (opcional)" class="p-2 border rounded w-full mt-2" />
          <button id="add-course" class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded">Adicionar Curso</button>
        </div>
      </section>

      <section class="mb-6">
        <h2 class="font-semibold">Filtros</h2>
        <select id="filter-professor" class="w-full p-2 border rounded mt-2">
          <option value="">Todos os professores</option>
        </select>
        <select id="filter-course" class="w-full p-2 border rounded mt-2">
          <option value="">Todos os cursos</option>
        </select>
        <div class="flex gap-2 mt-2">
          <button id="clear-filters" class="flex-1 p-2 bg-gray-300 rounded">Limpar</button>
          <button id="today-btn" class="flex-1 p-2 bg-blue-500 text-white rounded">Hoje</button>
        </div>
      </section>

      <section>
        <h2 class="font-semibold">Atalhos</h2>
        <div class="mt-2 space-y-2">
          <button id="open-event-modal" class="w-full p-2 bg-indigo-500 text-white rounded">Agendar Aula</button>
          <button id="export-data" class="w-full p-2 bg-gray-800 text-white rounded">Exportar JSON</button>
          <button id="import-data" class="w-full p-2 bg-yellow-500 text-black rounded">Importar JSON</button>
          <input id="import-file" type="file" accept="application/json" class="hidden" />
        </div>
      </section>

      <footer class="mt-6 text-xs text-gray-500">Dados salvos localmente no navegador (localStorage). Use exportar/importar para backup.</footer>
    </aside>

    <!-- Conteúdo principal: calendário -->
    <main class="flex-1 p-4">
      <div class="bg-white p-4 rounded shadow h-full flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h2 class="text-xl font-semibold">Calendário Semanal</h2>
            <p class="text-sm text-gray-500">Visualize e organize as aulas dos professores</p>
          </div>
          <div class="space-x-2">
            <button id="week-view" class="px-3 py-1 border rounded">Semana</button>
            <button id="month-view" class="px-3 py-1 border rounded">Mês</button>
            <button id="list-view" class="px-3 py-1 border rounded">Lista</button>
          </div>
        </div>

        <div id="calendar" class="flex-1"></div>
      </div>
    </main>
  </div>

  <!-- Modal de evento -->
  <div id="event-modal" aria-hidden="true">
    <div class="modal-card bg-white rounded p-6 w-[720px] max-w-full">
      <h3 class="text-lg font-bold mb-3">Agendar / Editar Aula</h3>
      <form id="event-form" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Turma (nome)</label>
            <input id="ev-title" class="w-full p-2 border rounded" placeholder="Ex: Turma A - 2º período" required />
          </div>
          <div>
            <label class="block text-sm">Curso</label>
            <select id="ev-course" class="w-full p-2 border rounded"></select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Professor</label>
            <select id="ev-teacher" class="w-full p-2 border rounded" required></select>
          </div>
          <div>
            <label class="block text-sm">Sala / Observação</label>
            <input id="ev-location" class="w-full p-2 border rounded" placeholder="Sala 101, Observação..." />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Data de Início</label>
            <input id="ev-start-date" type="date" class="w-full p-2 border rounded" required />
          </div>
          <div>
            <label class="block text-sm">Hora de Início</label>
            <input id="ev-start-time" type="time" class="w-full p-2 border rounded" required />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm">Data Final (mesmo dia se não recorrente)</label>
            <input id="ev-end-date" type="date" class="w-full p-2 border rounded" required />
          </div>
          <div>
            <label class="block text-sm">Hora de Término</label>
            <input id="ev-end-time" type="time" class="w-full p-2 border rounded" required />
          </div>
        </div>

        <div class="flex items-center gap-3">
          <input id="ev-recurring" type="checkbox" />
          <label class="text-sm">Repetir semanalmente até data final</label>
        </div>

        <input type="hidden" id="ev-id">

        <div class="flex justify-end gap-2">
          <button type="button" id="delete-event" class="bg-red-500 text-white px-3 py-2 rounded hidden">Excluir</button>
          <button type="button" id="cancel-event" class="px-3 py-2 border rounded">Cancelar</button>
          <button type="submit" class="px-3 py-2 bg-indigo-600 text-white rounded">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== Keys e Helpers =====
    const STORAGE_KEYS = {
      users: 'senai_users',
      teachers: 'senai_teachers',
      courses: 'senai_courses',
      events: 'senai_events'
    };

    function load(key, fallback = []) {
      try { return JSON.parse(localStorage.getItem(key)) || fallback; } catch(e) { return fallback; }
    }
    function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function uid(){ return 'id-'+Math.random().toString(36).slice(2,9); }

    // ===== Dados carregados =====
    let users = load(STORAGE_KEYS.users);
    let teachers = load(STORAGE_KEYS.teachers);
    let courses = load(STORAGE_KEYS.courses);
    let storedEvents = load(STORAGE_KEYS.events);

    // ===== Referências DOM =====
    const loginScreen = document.getElementById('login-screen');
    const registerScreen = document.getElementById('register-screen');
    const appScreen = document.getElementById('app-screen');
    const logoutBtn = document.getElementById('logout-btn');

    // Auth fields
    const loginEmail = document.getElementById('login-email');
    const loginPass = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');

    const regName = document.getElementById('register-name');
    const regEmail = document.getElementById('register-email');
    const regPass = document.getElementById('register-password');
    const regBtn = document.getElementById('register-btn');

    document.getElementById('go-register').addEventListener('click', (e)=>{ e.preventDefault(); loginScreen.style.display='none'; registerScreen.style.display='flex'; });
    document.getElementById('go-login').addEventListener('click', (e)=>{ e.preventDefault(); registerScreen.style.display='none'; loginScreen.style.display='flex'; });

    // Simple registration (stored locally) - NOTE: not secure, for demo only
    regBtn.addEventListener('click', ()=>{
      const name = regName.value.trim(), email = regEmail.value.trim(), pass = regPass.value.trim();
      if(!name||!email||!pass) return alert('Preencha todos os campos');
      if(users.some(u=>u.email===email)) return alert('E-mail já cadastrado');
      users.push({ id: uid(), name, email, pass });
      save(STORAGE_KEYS.users, users);
      alert('Cadastro realizado! Faça login.');
      regName.value=''; regEmail.value=''; regPass.value='';
      registerScreen.style.display='none'; loginScreen.style.display='flex';
    });

    // Login
    loginBtn.addEventListener('click', ()=>{
      const email = loginEmail.value.trim(), pass = loginPass.value.trim();
      if(!email||!pass) return alert('Preencha e-mail e senha');
      const user = users.find(u=>u.email===email && u.pass===pass);
      if(!user) return alert('Credenciais inválidas');
      // sucesso: abrir app
      loginEmail.value=''; loginPass.value='';
      loginScreen.style.display='none';
      registerScreen.style.display='none';
      appScreen.style.display='flex';
      startApp();
    });

    logoutBtn.addEventListener('click', ()=>{
      if(!confirm('Deseja realmente sair?')) return;
      // esconder app e voltar para login
      appScreen.style.display='none';
      loginScreen.style.display='flex';
      // destroy calendar instance by reloading page for simplicity
      location.reload();
    });

    // ===== UI Lateral - Professores / Cursos =====
    const teachersList = document.getElementById('teachers-list');
    const coursesList = document.getElementById('courses-list');
    const filterProfessor = document.getElementById('filter-professor');
    const filterCourse = document.getElementById('filter-course');

    document.getElementById('add-teacher').addEventListener('click', ()=>{
      const name = document.getElementById('teacher-name').value.trim();
      const area = document.getElementById('teacher-area').value.trim();
      if(!name) return alert('Nome do professor é obrigatório');
      teachers.push({ id: uid(), name, area });
      save(STORAGE_KEYS.teachers, teachers);
      document.getElementById('teacher-name').value=''; document.getElementById('teacher-area').value='';
      renderTeachers(); populateFilters(); populateFormSelects();
    });

    document.getElementById('add-course').addEventListener('click', ()=>{
      const name = document.getElementById('course-name').value.trim();
      const hours = document.getElementById('course-hours').value.trim();
      if(!name) return alert('Nome do curso é obrigatório');
      courses.push({ id: uid(), name, hours });
      save(STORAGE_KEYS.courses, courses);
      document.getElementById('course-name').value=''; document.getElementById('course-hours').value='';
      renderCourses(); populateFilters(); populateFormSelects();
    });

    function renderTeachers(){
      teachersList.innerHTML = '';
      teachers.forEach(t=>{
        const div = document.createElement('div');
        div.className='p-2 border rounded flex justify-between items-center';
        div.innerHTML = `<div><div class="font-semibold">${t.name}</div><div class="text-xs text-gray-500">${t.area||''}</div></div><button data-id="${t.id}" class="text-red-500">Remover</button>`;
        teachersList.appendChild(div);
        div.querySelector('button').addEventListener('click', ()=>{
          if(!confirm('Remover professor?')) return;
          teachers = teachers.filter(x=>x.id!==t.id); save(STORAGE_KEYS.teachers, teachers);
          renderTeachers(); populateFilters(); populateFormSelects();
        });
      });
    }

    function renderCourses(){
      coursesList.innerHTML = '';
      courses.forEach(c=>{
        const div = document.createElement('div');
        div.className='p-2 border rounded flex justify-between items-center';
        div.innerHTML = `<div><div class="font-semibold">${c.name}</div><div class="text-xs text-gray-500">${c.hours||''}</div></div><button data-id="${c.id}" class="text-red-500">Remover</button>`;
        coursesList.appendChild(div);
        div.querySelector('button').addEventListener('click', ()=>{
          if(!confirm('Remover curso?')) return;
          courses = courses.filter(x=>x.id!==c.id); save(STORAGE_KEYS.courses, courses);
          renderCourses(); populateFilters(); populateFormSelects();
        });
      });
    }

    function populateFilters(){
      filterProfessor.innerHTML = `<option value="">Todos os professores</option>` + teachers.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
      filterCourse.innerHTML = `<option value="">Todos os cursos</option>` + courses.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    }

    function populateFormSelects(){
      const evTeacher = document.getElementById('ev-teacher');
      const evCourse = document.getElementById('ev-course');
      evTeacher.innerHTML = '<option value="">Selecione professor</option>' + teachers.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
      evCourse.innerHTML = '<option value="">Selecione curso</option>' + courses.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    }

    // ===== FullCalendar + Eventos =====
    const calendarEl = document.getElementById('calendar');
    const eventModal = document.getElementById('event-modal');
    const eventForm = document.getElementById('event-form');

    let calendar = null;

    function mapStoredEventsToCalendar(sts){
      // If stored in older format, ensure start/end are ISO strings
      return sts.map(ev=>({
        id: ev.id,
        title: formatEventTitle(ev),
        start: ev.start,
        end: ev.end,
        extendedProps: { courseId: ev.courseId, courseName: ev.courseName, teacherId: ev.teacherId, teacherName: ev.teacherName, location: ev.location }
      }));
    }

    function formatEventTitle(ev){ return `[${ev.courseName || ''}] ${ev.title} — ${ev.teacherName || ''}`; }

    function initCalendar(){
      calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        initialView: 'timeGridWeek',
        height: '100%',
        nowIndicator: true,
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        selectable: true,
        editable: true,
        navLinks: true,
        headerToolbar: false,
        events: mapStoredEventsToCalendar(storedEvents),
        select: info => openEventModal(null, info.start, info.end),
        eventClick: info => openEventModal(info.event.extendedProps._customId || info.event.id),
        eventDrop: handleEventDrop,
        eventResize: handleEventResize
      });
      calendar.render();
    }

    function refreshCalendar(){
      storedEvents = load(STORAGE_KEYS.events);
      if(!calendar) return;
      calendar.removeAllEvents();
      calendar.addEventSource(mapStoredEventsToCalendar(storedEvents));
    }

    // Conflict check: same professor overlap
    function hasConflict(newStart, newEnd, teacherId, ignoreEventId=null){
      const ns = new Date(newStart).getTime();
      const ne = new Date(newEnd).getTime();
      return storedEvents.some(ev => {
        if(ignoreEventId && ev.id === ignoreEventId) return false;
        if(ev.teacherId !== teacherId) return false;
        const s = new Date(ev.start).getTime();
        const e = new Date(ev.end).getTime();
        return (ns < e) && (ne > s); // overlap
      });
    }

    function handleEventDrop(info){
      const ev = storedEvents.find(e=>e.id===info.event.id);
      const newStart = info.event.start;
      const newEnd = info.event.end;
      if(hasConflict(newStart, newEnd, ev.teacherId, ev.id)){
        alert('Conflito: professor já tem aula nesse horário.');
        info.revert();
        return;
      }
      ev.start = newStart.toISOString(); ev.end = newEnd.toISOString();
      save(STORAGE_KEYS.events, storedEvents);
    }

    function handleEventResize(info){
      const ev = storedEvents.find(e=>e.id===info.event.id);
      const newStart = info.event.start; const newEnd = info.event.end;
      if(hasConflict(newStart, newEnd, ev.teacherId, ev.id)){
        alert('Conflito ao redimensionar: professor já tem aula nesse horário.');
        info.revert();
        return;
      }
      ev.start = newStart.toISOString(); ev.end = newEnd.toISOString();
      save(STORAGE_KEYS.events, storedEvents);
    }

    // ===== Modal controls & form logic =====
    document.getElementById('open-event-modal').addEventListener('click', ()=> openEventModal());
    document.getElementById('cancel-event').addEventListener('click', closeEventModal);
    document.getElementById('delete-event').addEventListener('click', deleteEventFromModal);

    function openEventModal(eventId=null, start=null, end=null){
      document.getElementById('ev-id').value = eventId || '';
      document.getElementById('delete-event').classList.toggle('hidden', !eventId);
      populateFormSelects();

      if(eventId){
        const ev = storedEvents.find(e=>e.id===eventId);
        if(!ev) return alert('Evento não encontrado');
        document.getElementById('ev-title').value = ev.title;
        document.getElementById('ev-course').value = ev.courseId || '';
        document.getElementById('ev-teacher').value = ev.teacherId || '';
        document.getElementById('ev-location').value = ev.location || '';
        const s = new Date(ev.start), e = new Date(ev.end);
        document.getElementById('ev-start-date').value = s.toISOString().slice(0,10);
        document.getElementById('ev-start-time').value = s.toTimeString().slice(0,5);
        document.getElementById('ev-end-date').value = e.toISOString().slice(0,10);
        document.getElementById('ev-end-time').value = e.toTimeString().slice(0,5);
        document.getElementById('ev-recurring').checked = false;
      } else {
        // novo evento
        document.getElementById('ev-title').value = '';
        document.getElementById('ev-course').value = '';
        document.getElementById('ev-teacher').value = '';
        document.getElementById('ev-location').value = '';
        if(start && end){
          const s = new Date(start); const e = new Date(end);
          document.getElementById('ev-start-date').value = s.toISOString().slice(0,10);
          document.getElementById('ev-start-time').value = s.toTimeString().slice(0,5);
          document.getElementById('ev-end-date').value = e.toISOString().slice(0,10);
          document.getElementById('ev-end-time').value = e.toTimeString().slice(0,5);
        } else {
          const today = new Date();
          document.getElementById('ev-start-date').value = today.toISOString().slice(0,10);
          document.getElementById('ev-end-date').value = today.toISOString().slice(0,10);
          document.getElementById('ev-start-time').value = '13:00';
          document.getElementById('ev-end-time').value = '15:00';
        }
      }

      // abrir modal
      eventModal.classList.add('active');
      eventModal.setAttribute('aria-hidden','false');
    }

    function closeEventModal(){
      eventModal.classList.remove('active');
      eventModal.setAttribute('aria-hidden','true');
    }

    function deleteEventFromModal(){
      const id = document.getElementById('ev-id').value;
      if(!id) return;
      if(!confirm('Excluir evento?')) return;
      storedEvents = storedEvents.filter(e=>e.id!==id);
      save(STORAGE_KEYS.events, storedEvents);
      refreshCalendar();
      closeEventModal();
    }

    eventForm.addEventListener('submit', e=>{
      e.preventDefault();
      const id = document.getElementById('ev-id').value || uid();
      const title = document.getElementById('ev-title').value.trim();
      const courseId = document.getElementById('ev-course').value;
      const courseName = (courses.find(c=>c.id===courseId) || {}).name || '';
      const teacherId = document.getElementById('ev-teacher').value;
      const teacherName = (teachers.find(t=>t.id===teacherId) || {}).name || '';
      const location = document.getElementById('ev-location').value.trim();
      const startDate = document.getElementById('ev-start-date').value;
      const startTime = document.getElementById('ev-start-time').value;
      const endDate = document.getElementById('ev-end-date').value;
      const endTime = document.getElementById('ev-end-time').value;
      const recurring = document.getElementById('ev-recurring').checked;

      const startISO = new Date(startDate+'T'+startTime+':00').toISOString();
      const endISO = new Date(endDate+'T'+endTime+':00').toISOString();
      if(new Date(startISO) >= new Date(endISO)) return alert('Hora de término deve ser depois da hora de início.');

      // recurring weekly
      if(recurring){
        const baseStart = new Date(startDate+'T'+startTime+':00');
        const finalDate = new Date(endDate+'T23:59:59');
        let cursor = new Date(baseStart);
        const created = [];
        while(cursor <= finalDate){
          const s = new Date(cursor);
          const e = new Date(s.getTime() + (new Date(endISO) - new Date(startISO)));
          if(hasConflict(s, e, teacherId, null)){
            // pule conflito (avisa)
            console.warn('Conflito detectado em '+s.toLocaleString());
          } else {
            const evObj = { id: uid(), title, courseId, courseName, teacherId, teacherName, location, start: s.toISOString(), end: e.toISOString() };
            storedEvents.push(evObj); created.push(evObj);
          }
          cursor.setDate(cursor.getDate()+7);
        }
        save(STORAGE_KEYS.events, storedEvents);
        refreshCalendar(); closeEventModal();
        return;
      }

      // single event
      if(hasConflict(startISO, endISO, teacherId, id)) return alert('Conflito: professor já tem aula nesse horário.');

      const existsIndex = storedEvents.findIndex(x=>x.id===id);
      const evObj = { id, title, courseId, courseName, teacherId, teacherName, location, start: startISO, end: endISO };
      if(existsIndex>=0) storedEvents[existsIndex] = evObj; else storedEvents.push(evObj);
      save(STORAGE_KEYS.events, storedEvents);
      refreshCalendar(); closeEventModal();
    });

    // ===== Filters / Views / Export-Import =====
    document.getElementById('filter-professor').addEventListener('change', applyFilters);
    document.getElementById('filter-course').addEventListener('change', applyFilters);
    document.getElementById('clear-filters').addEventListener('click', ()=>{ filterProfessor.value=''; filterCourse.value=''; applyFilters(); });
    document.getElementById('today-btn').addEventListener('click', ()=> calendar && calendar.today());

    function applyFilters(){
      const prof = filterProfessor.value; const course = filterCourse.value;
      if(!calendar) return;
      calendar.removeAllEvents();
      let filtered = storedEvents.slice();
      if(prof) filtered = filtered.filter(e=>e.teacherId===prof);
      if(course) filtered = filtered.filter(e=>e.courseId===course);
      calendar.addEventSource(mapStoredEventsToCalendar(filtered));
    }

    document.getElementById('week-view').addEventListener('click', ()=> calendar && calendar.changeView('timeGridWeek'));
    document.getElementById('month-view').addEventListener('click', ()=> calendar && calendar.changeView('dayGridMonth'));
    document.getElementById('list-view').addEventListener('click', ()=> calendar && calendar.changeView('listWeek'));

    document.getElementById('export-data').addEventListener('click', ()=>{
      const dump = { teachers, courses, events: storedEvents };
      const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'senai_agenda_export.json'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('import-data').addEventListener('click', ()=> document.getElementById('import-file').click());
    document.getElementById('import-file').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      const txt = await f.text();
      try{
        const parsed = JSON.parse(txt);
        teachers = parsed.teachers || teachers; courses = parsed.courses || courses; storedEvents = parsed.events || storedEvents;
        save(STORAGE_KEYS.teachers, teachers); save(STORAGE_KEYS.courses, courses); save(STORAGE_KEYS.events, storedEvents);
        renderTeachers(); renderCourses(); populateFilters(); populateFormSelects(); refreshCalendar();
        alert('Importado com sucesso');
      }catch(e){ alert('Arquivo inválido'); }
    });

    // ===== Inicialização do app após login =====
    function startApp(){
      renderTeachers(); renderCourses(); populateFilters(); populateFormSelects();
      initCalendar();
    }

    // Se quiser já manter logado (fluxo simples): checar flag (não implementado por padrão)
    // Inicialização — deixa no estado de login até o usuário entrar
  </script>
</body>
</html>
